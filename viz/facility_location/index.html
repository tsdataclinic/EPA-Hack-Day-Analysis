<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Tiles</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map-container {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map-container"></div>
    <div id="legend"></div>

    <script>
        mapboxgl.accessToken = "pk.eyJ1IjoiY2FueW9uZm9vdCIsImEiOiJjbGw2eG85M3MwcmY5M2xud29mZHVydDBrIn0.nGzozJxSqhZMETPdVsqjbw";
        const city = "nyc";
        const raceColors = {
            "White": "#00a5bd",
            "Black": "#7a10aa",
            "Asian": "#fd1e46",
            "Hispanic": "#f5d855",
            "Other": "#666666"
        };

        const map = new mapboxgl.Map({
            container: 'map-container',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [-8.1994, 38.6260],
            zoom: 5
        });

        let currentPopup = null;

        map.on('load', function () {
            // Hide settlement labels
            map.setLayoutProperty('settlement-label', 'visibility', 'none');
            map.setLayoutProperty('poi-label', 'visibility', 'none');

            fetch(`../viz_data/RMP_facilities.geojson`)
                .then(response => response.json())
                .then(data => {
                    let totalLat = 0;
                    let totalLng = 0;
                    let count = data.features.length;

                    for (let feature of data.features) {
                        totalLat += feature.geometry.coordinates[1];
                        totalLng += feature.geometry.coordinates[0];
                    }

                    let avgLat = totalLat / count;
                    let avgLng = totalLng / count;
                    map.setCenter([avgLng, avgLat]);

                    map.addSource("points", {
                        type: "geojson",
                        data: data
                    });

                    map.addLayer({
                        id: "points",
                        type: "circle",
                        source: "points",
                        paint: {
                            "circle-radius": {
                                'base': 2,
                                'stops': [[6, 2], [12, 10]]
                            },
                            'circle-color': [
                                'match',
                                ['get', 'race'],
                                'White', raceColors.White,
                                'Black', raceColors.Black,
                                'Asian', raceColors.Asian,
                                'Hispanic/Latino', raceColors.Hispanic,
                                raceColors.Other
                            ]
                        }
                    });

                    generateLegend();

                    return fetch(`../viz_data/urban_areas.geojson`);
                })
                .then(response => response.json())
                .then(data => {
                    map.addSource("polygons", {
                        type: "geojson",
                        data: data
                    });

                    map.addLayer({
                        id: "polygons",
                        type: "line",
                        source: "polygons",
                        layout: {},
                        paint: {
                            "line-color": "#000000",
                            "line-width": 2
                        }
                    });
                });

            map.on('mousemove', 'points', function (e) {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    map.getCanvas().style.cursor = 'pointer';

                    if (currentPopup) {
                        currentPopup.remove();
                    }

                    currentPopup = new mapboxgl.Popup({ offset: 25 })
                        .setLngLat(e.lngLat)
                        .setHTML(feature.properties.description)
                        .addTo(map);
                }
            });

            map.on('mouseleave', 'points', function () {
                map.getCanvas().style.cursor = '';
                if (currentPopup) {
                    currentPopup.remove();
                }
            });
        });

        function generateLegend() {
            const legendContainer = document.getElementById('legend');
            const legendTitle = document.createElement('p');
            legendTitle.innerText = "Each dot represents \n 100 people";
            legendTitle.style.fontWeight = 'bold';
            legendContainer.appendChild(legendTitle);
            for (let race in raceColors) {
                const color = raceColors[race];
                const colorBox = document.createElement('div');
                colorBox.style.backgroundColor = color;
                colorBox.style.width = '20px';
                colorBox.style.height = '20px';
                colorBox.style.display = 'inline-block';
                colorBox.style.marginRight = '5px';
                const raceLabel = document.createTextNode(race);
                const legendItem = document.createElement('div');
                legendItem.appendChild(colorBox);
                legendItem.appendChild(raceLabel);
                legendContainer.appendChild(legendItem);
            }
        }
    </script>
</body>
</html>
